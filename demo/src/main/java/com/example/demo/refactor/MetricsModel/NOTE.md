# 开发一个小的框架,用于获取接口调用的各种统计信息(响应时间最大值,最小值,平均值,调用次数,频率)


## 需求分析
1. 接口统计信息：包括接口响应时间的统计信息，以及接口调用次数的统计信息等。
2. 统计信息的类型：max、min、avg、percentile、count、tps 等。
3. 统计信息显示格式：Json、Html、自定义显示格式。
4. 统计信息显示终端：Console、Email、HTTP 网页、日志、自定义显示终端
5. 统计触发方式：包括主动和被动两种。主动表示以一定的频率定时统计数据，并主动推送到显示终端，比如邮件推送。被动表示用户触发统计，比如用户在网页中选择要统计的时间区间，触发统计，并将结果显示给用户。
6. 统计时间区间：框架需要支持自定义统计时间区间，比如统计最近 10 分钟的某接口的 tps、访问次数，或者统计 12 月 11 日 00 点到 12 月 12 日 00 点之间某接口响应时间的最大值、最小值、平均值等。
7. 统计时间间隔：对于主动触发统计，我们还要支持指定统计时间间隔，也就是多久触发一次统计显示。比如，每间隔 10s 统计一次接口信息并显示到命令行中，每间隔 24 小时发送一封统计信息邮件。

## 补充
### TPS
- TPS：Transactions Per Second（每秒传输的事物处理个数），即服务器每秒处理的事务数。TPS包括一条消息入和一条消息出，加上一次用户数据库访问。（业务TPS = CAPS × 每个呼叫平均TPS）
- TPS是软件测试结果的测量单位。一个事务是指一个客户机向服务器发送请求然后服务器做出反应的过程。客户机在发送请求时开始计时，收到服务器响应后结束计时，以此来计算使用的时间和完成的事务个数。
- 一般的，评价系统性能均以每秒钟完成的技术交易的数量来衡量。系统整体处理能力取决于处理能力最低模块的TPS值。
### QPS
- QPS：每秒查询率QPS是对一个特定的查询服务器在规定时间内所处理流量多少的衡量标准，在因特网上，作为域名系统服务器的机器的性能经常用每秒查询率来衡量。
- 对应fetches/sec，即每秒的响应请求数，也即是最大吞吐能力。

## 第一次代码
- 直接创建`Metrics`类,在里面执行数据采集,统计,推送等方法

## 第二次代码
### MetricsCollecor(指标)
- 负责收集数据
- 注入MetricsStorge,对数据进行存储
### MetricsStorage(存储)
- 以接口形式存在,包括存储(saveRequestInfo),获取(getRequestInfos)两个接口
- 基于不同的存储方式继承该接口,Redis,Mysql等
### Aggregator类(合计)
- 负责接收数据,统计最值,总和,tps等信息
### EmailSender(通过邮件发送统计信息)
- 初始化EmailSender类
- 开启线程,每天发送一封邮件
- 基于时间间隔,从storge中获取数据
- 调用Aggregator,对数据进行统计
- 将统计数据以html格式输出,然后发送邮件
### ConsoleReporter(以命令行的形式发送)
- 初始化metrics,加载数据
- 通过Aggregator对数据进行统计
- 将信息组合为json
- 通过log或者print输出到命令行

## 总结
- 在第一次重构时,将原来的一个类进行拆分
- 采集,存储,统计,输出,每个功能对应一个类
- 最后去进行组合,并且存储使用接口去实现,更方便拓展
- 